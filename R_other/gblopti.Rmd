---
title: "Optimization with boundary layer conductance"
author: "Remko Duursma"
date: "Monday, June 16, 2014"
output:
  html_document:
    fig_caption: yes
---


### Exploring the Penman-Monteith equation

Here, a couple of key figures using the Penman-Monteith equation. Leaf temperature is calculated by closing the energy balance (numerically), taking into all temperature effects. For the following figures, wind speed (and hence boundary layer conductance) and stomatal conductance were inputs, and transpiration and leaf temperature are simulated.


```{r echo=FALSE, message=FALSE}
library(plantecophys)
library(magicaxis)


windlabel <- expression(Wind~speed~~(m~s^-1))


gslow <- 0.02
gshigh <- 0.5

Winds <- exp(seq(log(0.1), log(10), length=25))
```

These simulations are with `plantecophys` package version `r packageVersion("plantecophys")`.


```{r echo=FALSE, message=FALSE, fig.cap="Figure 1. Leaf temperature calculated from energy balance, given a constant low or high stomatal conductance. Note how wind speed increases leaf temperature when gs is high, but decreases it when it is low. Monteith (1965) showed a similar figure."}

# Calculate Tleaf given known gs, from energy balance
rlow <- sapply(Winds, function(x)plantecophys:::FindTleaf(gs=gslow, Wind=x, Tair=25))
rhigh <- sapply(Winds, function(x)plantecophys:::FindTleaf(gs=gshigh, Wind=x, Tair=25))

plot(log10(Winds), rlow, ylim=c(20,30), type='l', col="red", axes=FALSE,
     xlab=windlabel, ylab=expression(T[leaf]~~(degree*C)))
points(log10(Winds), rhigh, type='l', col="blue")

abline(h=25)
magaxis(side=1, unlog=1)
axis(2)
box()
legend("topright", legend=sapply(c(bquote(g[s] == .(gslow)),
                          bquote(g[s] == .(gshigh)),
                          bquote(T[air])
                          ),as.expression), lty=1, col=c("red","blue","black"),
       cex=0.9)
```



```{r echo=FALSE, fig.cap="Figure 2. Leaf transpiration estimated from stomatal conductance and wind speed, using Penmon-Monteith and solved leaf temperature. At low wind speed, the low boundary layer conductance leads to a curved relationship between E and gs. Note that at low gs, E is higher in low wind speed. This is due to increased leaf temperature as a result of low conductance to heat, which increases the leaf-to-air VPD. At high wind speed, we see the approximate E = gs*VPD relationship."}

# Calculate ELEAF given known gs; calculate Tleaf from energy balance.
f <- function(w,gs,...){
  
  tleaf <- plantecophys:::FindTleaf(gs=gs, Wind=w, Tair=25,VPD=1)
  flux <- plantecophys:::LeafEnergyBalance(Tleaf=tleaf, Wind=w, Tair=25, gs=gs, 
                                           VPD=1,
                                           returnwhat="fluxes")
  flux$Tleaf <- tleaf

return(flux)
}

# Wind speed and E/gs
gss <- seq(0.02, 0.5, length=25)
windlow <- 0.1
windhigh <- 10

wlow <- do.call(rbind, lapply(gss, function(x)f(windlow,x)))
whigh <- do.call(rbind, lapply(gss, function(x)f(windhigh,x)))

plot(gss, wlow$ELEAFeb, type='l', col="red", ylim=c(0,5),xlim=c(0,0.6),
     xlab=expression(g[s]~~(mol~m^-2~s^-1)),
     ylab=expression(E[leaf]~~(mmol~m^-2~s^-1)))

points(gss, whigh$ELEAFeb, type='l', col="blue")

legend("topleft", legend=sapply(c(bquote(wind == .(windlow)),
                                   bquote(wind == .(windhigh))),as.expression), 
       lty=1, col=c("red","blue"), cex=0.9)
```




```{r echo=FALSE, fig.cap="Figure 3. Test of the approximate relationship E = gs*VPD (note molar units), with varying wind speed and at low and high stomatal conductance. For this simulation, VPD was set to 0.01 mol mol-1 (ca. 1 kPa). As we know, at high wind speeds (when leaves are 'well coupled'), the ratio E/gs should then converge to VPD, as it does. Consistent with the above figures, there is an interaction between wind speed and gs."}
rlow <- do.call(rbind,lapply(Winds, function(x)f(x, gs=gslow)))
rhigh <- do.call(rbind,lapply(Winds, function(x)f(x, gs=gshigh)))

plot(log10(Winds), rlow$ELEAFeb/gslow/1000,  type='l', col="red", ylim=c(0,0.02),
     axes=FALSE,  xlab=windlabel, ylab=expression(E[leaf]/g[s]~~(mol~mol^-1)))
points(log10(Winds), rhigh$ELEAFeb/gshigh/1000, type='l', col="blue")
abline(h=0.01)

magaxis(side=1, unlog=1)
axis(2)
box()
legend("topright", legend=sapply(c(bquote(g[s] == .(gslow)),
                                   bquote(g[s] == .(gshigh)),
                                   bquote(VPD)), as.expression),
       lty=1, col=c("red","blue","black"))

f <- lapply(Winds, function(x)FARAO2(Wind=x, energybalance=TRUE))
f <- do.call(rbind,f)
```




### FARAO with energy balance

Here, I show some simulations with FARAO (FARquhar And Optimization). A new implementation follows Buckley et al. (2014). Using the leaf gas exchange model (that takes Ci, Tair - and other drivers of course - and calculates A, E, gs and Tleaf), lambda was calculated numerically with,

$$\frac{dA}{dE} == \frac{dA / dC_i}{dE / dC_i}$$

This was done by calculating A and E at a given Ci, then adding a very small number, and calculating $dA = A(C_i+d) - A(C_i)$. Then, the Ci at which the calculated lambda was equal to a preset value was found by optimization.


```{r eval=TRUE, echo=FALSE, fig.cap="Figure 4. VPD response of GS at constant Tair, using the full numerical optimization with energy balance. At lower wind speed, a higher gs is achieved at a given VPD. This is the result of the higher calculated leaf temperature (and its positive effect on photosynthesis). Note that at high VPD, the numerical solution does not converge (this means there is no optimal gs in that region, cf. Buckley et al 2014)."}
vpds <- seq(1, 3.5, length=25)
windlow <- 0.4
windhigh <- 10
runcon <- FARAO2(energybalance=FALSE, VPD=vpds)
run1 <- FARAO2(energybalance=TRUE, VPD=vpds, Wind=windlow)
run2 <- FARAO2(energybalance=TRUE, VPD=vpds, Wind=windhigh)

run1 <- run1[is.finite(run1$ELEAF),]
run2 <- run2[is.finite(run2$ELEAF),]

with(runcon, plot(VPD, GS, type='l', ylim=c(0,0.16),
                  xlab="VPD (air) (kPa)",
                  ylab=expression(g[s]~~(mol~m^-2~s^-1))))
with(run1, points(VPD, GS, type='l', col="red"))
with(run2, points(VPD, GS, type='l', col="blue"))
legend("bottomleft", c("No energy balance","Wind = 0.4", "Wind = 10"),
       lty=1, col=c("black","red","blue"))

```


```{r, warning=FALSE, error=FALSE,fig.cap="Figure 5. PPFD, Tair and VPD were varied randomly, gs was calculated with FARAO, either without energy balance (assuming Tleaf=Tair), or solving for Tleaf depending on wind speed. It appears that g0 increases with decreasing wind speed. This may be explained as in the above: at low wind speed (low boundary layer conductance), Tleaf increases, which increases A and hence gs at a given lambda."  }

n <- 101
set.seed(1111)
pars <- runif(n, 200,1000)
vpds <- runif(n,1,3.5)
tairs <- runif(n,15,28)
windlow <- 0.4
windhigh <- 10


runcon <- FARAO2(energybalance=FALSE, VPD=vpds, PPFD=pars, Tleaf=tairs)
run1 <- FARAO2(energybalance=TRUE, VPD=vpds, Tair=tairs, PPFD=pars, Wind=windlow)
run2 <- FARAO2(energybalance=TRUE, VPD=vpds, Tair=tairs, PPFD=pars, Wind=windhigh)
run1 <- run1[is.finite(run1$ELEAF),]
run2 <- run2[is.finite(run2$ELEAF),]

f <- function(x)x$ALEAF/(x$Ca*sqrt(x$VPD))
runcon$bb <- f(runcon)
run1$bb <- f(run1)
run2$bb <- f(run2)

# inferred GS
f2 <- function(x)10^-3*x$ELEAF/(x$VPD/101)
runcon$GSinf <- f2(runcon)
run1$GSinf <- f2(run1)
run2$GSinf <- f2(run2)


with(runcon, plot(bb, GS, pch=19, ylim=c(0,0.25), xlim=c(0,0.04),
                  xlab=expression(A/C[a]*sqrt(D[air])), 
                  ylab=expression(g[s]~~(mol~m^-2~s^-1))))
with(run1, points(bb, GS, pch=19, col="red"))
with(run2, points(bb, GS, pch=19, col="blue"))
legend("topleft", c("No energy balance","Wind = 0.4", "Wind = 10"),
       lty=1, col=c("black","red","blue"))

abline(lm(GS ~ bb, data=runcon))
abline(lm(GS ~ bb, data=run1), col="red")
abline(lm(GS ~ bb, data=run2), col="blue")
```


```{r, echo=FALSE, fig.cap="Figure 6. The previous figure is exactly opposite to what Yan-Shih has shown in comparisons of flux data to leaf data (where g1 was often lower for canopy scale fluxes). However, there, gs was inferred from evapotranspiration, not directly measured at the prevailing boundary layer conductance. This figure shows gs inferred from leaf transpiration, assuming infinite boundary layer conductance (gs = E/VPD), it shows that g0 nor g1 are affected by the boundary layer conductance, if VPD is the air VPD, and gs is inferred from transpiration. I think this means our theory is entirely valid regardless of what the boundary layer conductance is, because its effects somehow cancel out!"}

with(runcon, plot(bb, GSinf, pch=19, xlim=c(0,0.04),  ylim=c(0,0.2), 
                  xlab=expression(A/C[a]*sqrt(D[air])), 
                  ylab=expression(Inferred~g[s]~~(mol~m^-2~s^-1))))
with(run1, points(bb, GSinf, pch=19, col="red"))
with(run2, points(bb, GSinf, pch=19, col="blue"))
abline(lm(GSinf ~ bb, data=runcon))
abline(lm(GSinf ~ bb, data=run1), col="red")
abline(lm(GSinf ~ bb, data=run2), col="blue")

legend("topleft", c("No energy balance","Wind = 0.4", "Wind = 10"),
       lty=1, col=c("black","red","blue"))

```







```{r echo=FALSE, eval=FALSE, warning=FALSE}
# This is to check it works; here we found a discnontinuity before.
windlow <- 0.5
windhigh <- 10

Cis <- seq(100,375, length=101)

rlow <- PhotosynEB(Ci=Cis, Wind=windlow)
rhigh <- PhotosynEB(Ci=Cis, Wind=windhigh)
rcon <- Photosyn(Ci=Cis)

with(rcon, plot(Ci, ALEAF, type='l'))
with(rlow, points(Ci, ALEAF, type='l', col="red"))
with(rhigh, points(Ci, ALEAF, type='l', col="blue"))

with(rcon, plot(Ci, ELEAF, type='l'))
with(rlow, points(Ci, ELEAF, type='l', col="red"))
with(rhigh, points(Ci, ELEAF, type='l', col="blue"))

with(rcon, plot(Ci, Tleaf, type='l'))
with(rlow, points(Ci, Tleaf, type='l', col="red"))
with(rhigh, points(Ci, Tleaf, type='l', col="blue"))
```











